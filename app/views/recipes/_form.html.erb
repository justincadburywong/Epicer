<%= form_with model: recipe, class: "space-y-6" do |form| %>
  <% if recipe.errors.any? %>
    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
      <h2 class="text-red-800 font-semibold"><%= pluralize(recipe.errors.count, "error") %> prohibited this recipe from being saved:</h2>
      <ul class="list-disc list-inside mt-2 text-red-700">
        <% recipe.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div>
    <%= form.label :title, class: "block text-sm font-medium text-gray-700 mb-1" %>
    <%= form.text_field :title, class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500", required: true %>
  </div>

  <div>
    <%= form.label :description, class: "block text-sm font-medium text-gray-700 mb-1" %>
    <%= form.text_area :description, rows: 3, class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500" %>
  </div>

  <div>
    <%= form.label :source_url, "Source URL", class: "block text-sm font-medium text-gray-700 mb-1" %>
    <%= form.url_field :source_url, class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500", placeholder: "https://..." %>
  </div>

  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
    <div>
      <%= form.label :prep_time, "Prep Time (min)", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= form.number_field :prep_time, min: 0, class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500" %>
    </div>
    <div>
      <%= form.label :cook_time, "Cook Time (min)", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= form.number_field :cook_time, min: 0, class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500" %>
    </div>
    <div>
      <%= form.label :servings, class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= form.number_field :servings, min: 1, class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500" %>
    </div>
  </div>

  <fieldset class="border border-gray-200 rounded-lg p-4">
    <legend class="text-sm font-medium text-gray-700 px-2">Ingredients</legend>
    <div id="ingredients" class="space-y-3">
      <%= form.fields_for :ingredients do |ingredient_form| %>
        <%= render "ingredient_fields", form: ingredient_form %>
      <% end %>
    </div>
    <template id="ingredient-template">
      <%= form.fields_for :ingredients, Ingredient.new, child_index: "NEW_RECORD" do |ingredient_form| %>
        <%= render "ingredient_fields", form: ingredient_form %>
      <% end %>
    </template>
    <button type="button" 
            onclick="addIngredient()" 
            class="mt-3 text-emerald-600 hover:text-emerald-700 text-sm font-medium">
      + Add Ingredient
    </button>
  </fieldset>

  <div>
    <%= form.label :instructions, class: "block text-sm font-medium text-gray-700 mb-1" %>
    <%= form.text_area :instructions, rows: 8, class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500", placeholder: "Enter each step on a new line..." %>
  </div>

  <div data-controller="star-rating">
    <%= form.label :rating, class: "block text-sm font-medium text-gray-700 mb-1" %>
    <%= form.hidden_field :rating, data: { star_rating_target: "input" } %>
    <div class="flex gap-1 text-2xl cursor-pointer" data-action="mouseleave->star-rating#reset">
      <% 5.times do |i| %>
        <span data-star-rating-target="star" 
              data-rating="<%= i + 1 %>"
              data-action="click->star-rating#select mouseenter->star-rating#hover"
              class="text-gray-300 transition-colors">★</span>
      <% end %>
      <button type="button" 
              data-action="click->star-rating#select" 
              data-rating="0"
              class="ml-2 text-sm text-gray-500 hover:text-gray-700">Clear</button>
    </div>
  </div>

  <div>
    <%= form.label :notes, class: "block text-sm font-medium text-gray-700 mb-1" %>
    <%= form.text_area :notes, rows: 3, class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500", placeholder: "Personal notes, tips, modifications..." %>
  </div>

  <fieldset class="border border-gray-200 rounded-lg p-4">
    <legend class="text-sm font-medium text-gray-700 px-2">Images</legend>
    <% if recipe.persisted? && recipe.images.attached? %>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-3">
        <% recipe.images.each do |image| %>
          <div class="relative group">
            <%= image_tag image, class: "w-full h-24 object-cover rounded" %>
            <%= link_to "×", purge_image_recipe_path(recipe, image_id: image.id), 
                data: { turbo_method: :delete, turbo_confirm: "Remove this image?" },
                class: "absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs leading-5 text-center opacity-0 group-hover:opacity-100 transition-opacity" %>
          </div>
        <% end %>
      </div>
    <% end %>
    <%= form.file_field :images, multiple: true, accept: "image/*", 
        class: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100" %>
    <p class="mt-1 text-xs text-gray-500">Upload photos of your dish. Multiple files allowed.</p>
  </fieldset>

  <fieldset class="border border-gray-200 rounded-lg p-4">
    <legend class="text-sm font-medium text-gray-700 px-2">Documents</legend>
    <% if recipe.persisted? && recipe.documents.attached? %>
      <ul class="mb-3 space-y-1">
        <% recipe.documents.each do |doc| %>
          <li class="flex items-center justify-between text-sm">
            <%= link_to doc.filename, rails_blob_path(doc, disposition: "attachment"), class: "text-emerald-600 hover:underline" %>
            <%= link_to "Remove", purge_document_recipe_path(recipe, document_id: doc.id), 
                data: { turbo_method: :delete, turbo_confirm: "Remove this document?" },
                class: "text-red-500 hover:text-red-700 text-xs" %>
          </li>
        <% end %>
      </ul>
    <% end %>
    <%= form.file_field :documents, multiple: true, accept: ".pdf,.doc,.docx,.txt",
        class: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" %>
    <p class="mt-1 text-xs text-gray-500">Upload PDFs or documents. Multiple files allowed.</p>
  </fieldset>

  <div class="flex gap-4">
    <%= form.submit class: "bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-6 rounded-lg cursor-pointer" %>
    <%= link_to "Cancel", recipes_path, class: "py-2 px-4 text-gray-600 hover:text-gray-800" %>
  </div>
<% end %>

<script>
  function addIngredient() {
    const template = document.getElementById('ingredient-template');
    const container = document.getElementById('ingredients');
    const content = template.innerHTML.replace(/NEW_RECORD/g, new Date().getTime());
    container.insertAdjacentHTML('beforeend', content);
  }

  function removeIngredient(button) {
    const wrapper = button.closest('.ingredient-fields');
    const destroyInput = wrapper.querySelector('input[name*="_destroy"]');
    if (destroyInput) {
      destroyInput.value = '1';
      wrapper.style.display = 'none';
    } else {
      wrapper.remove();
    }
  }
</script>
